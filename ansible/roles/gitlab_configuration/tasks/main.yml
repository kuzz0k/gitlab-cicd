---
- name: Copy Docker daemon configuration
  copy:
    src: daemon.json
    dest: /etc/docker/daemon.json
    mode: '0644'
  notify: restart docker

- name: Flush handlers to restart Docker immediately
  meta: flush_handlers

- name: Create GitLab directory structure
  file:
    path: "/srv/gitlab/{{ item }}"
    state: directory
    mode: '0750'
  loop:
    - config
    - logs
    - data

- name: Create docker-compose.yml from template
  template:
    src: docker-compose.yml.j2
    dest: /srv/gitlab/docker-compose.yml
    mode: '0644'

- name: Deploy GitLab via Docker Compose
  community.docker.docker_compose_v2:
    project_src: /srv/gitlab
    state: present
    pull: always

- name: Wait for GitLab to be healthy (can take 2-5 minutes)
  community.docker.docker_container_info:
    name: gitlab
  register: result
  until: result.container.State.Health.Status == "healthy"
  retries: 30
  delay: 15

- name: Wait for initial root password file to exist
  wait_for:
    path: /srv/gitlab/config/initial_root_password
    state: present
    timeout: 60

- name: Read initial root password
  slurp:
    src: /srv/gitlab/config/initial_root_password
  register: root_password_b64

- name: Display GitLab Access Info
  debug:
    msg: 
      - "GitLab is UP and Healthy!"
      - "URL: http://{{ gitlab_external_url }}:{{ gitlab_http_port }}"
      - "Login: root"
      - "Password: {{ root_password_b64['content'] | b64decode | regex_search('Password:\\s*(\\S+)', '\\1') | first | default('NOT_FOUND') }}"
