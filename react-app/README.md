# React App

Простое React приложение, настроенное для автоматического деплоя через GitLab CI.

### Особенности

*   **Docker Layer Caching**: Для ускорения сборки используется кэширование слоев Docker. Перед билдом загружается предыдущая версия образа, что позволяет не пересобирать зависимости 
*   **Healthcheck**: После запуска приложения происходит автоматическая проверка статуса контейнеров. Если приложение падает сразу после старта, деплой помечается как неудачный.

### Этапы (Stages)

#### 1. Build
*   Логин в Docker Registry.
*   `docker pull` предыдущего образа для кэша.
*   `docker build` с флагом `--cache-from`.
*   `docker push` собранного образа в Registry.

#### 2. Deploy
Выполняется на удаленном сервере через SSH.
*   Копирование конфигурации `docker-compose.yml`.
*   Создание `.env` файла с актуальным тегом образа (`IMAGE_NAME`).
*   Обновление контейнеров: `docker compose pull && docker compose up -d`.
*   **Проверка**: `sleep 5` и проверка вывода `docker compose ps` на наличие статуса `Up`.
*   Очистка старых образов.

### Переменные окружения (CI/CD Variables)

Для работы пайплайна в настройках репозитория должны быть заданы:

*   `SSH_PRIVATE_KEY`: Приватный SSH ключ для доступа к целевому серверу.
*   `TARGET_IP`: IP адрес сервера.
*   `CI_REGISTRY`: (Автоматическая) Адрес Docker Registry.

### Переход на SSL (HTTPS)

Если вы настроили SSL сертификаты для Registry и вашего домена, необходимо внести изменения в конфигурацию:

1.  **`.gitlab-ci.yml`**:
    *   Убрать флаг небезопасного реестра в сервисе `docker:dind`:
        ```diff
        - command: ["--insecure-registry=192.168.1.99:5050"]
        ```
    *   Изменить протокол `REGISTRY_URL` на `https` (если используется):
        ```yaml
        REGISTRY_URL: "https://$CI_REGISTRY"
        ```

2.  **`.hosting/docker-compose.yml`**:
    *   Обновить проброс портов для HTTPS:
        ```yaml
        ports:
          - "80:80"
          - "443:443"
        ```
    *   При необходимости пробросить тома с сертификатами.
